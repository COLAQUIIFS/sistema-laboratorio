<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reserva dos Laboratórios de Química</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
            --admin: #8e44ad;
            --tech: #16a085;
            --professor: #3498db; /* Nova cor para professor */
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a3a, #2c3e50);
            color: #fff;
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 50px;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            font-size: 1.8rem;
            background: var(--secondary);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-text {
            display: flex;
            flex-direction: column;
        }
        
        .logo-text h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .logo-text p {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-left: 10px;
        }

        .user-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 2px;
        }

        .connection-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .connection-status.online {
            background-color: var(--success);
        }

        .connection-status.offline {
            background-color: var(--danger);
        }

        .role-tag {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .role-admin {
            background: var(--admin);
        }
        
        .role-tech {
            background: var(--tech);
        }
        
        .role-professor { /* Estilo para professor */
            background: var(--professor);
        }

        .btn-logout {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.1);
        }
        
        /* Tabs Container */
        .tabs-container {
            position: relative;
            margin: 20px 0;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            z-index: 1;
        }

        .tab i {
            font-size: 1.1rem;
        }

        .tab.active {
            color: var(--secondary);
            font-weight: bold;
        }

        .tab-indicator {
            position: absolute;
            bottom: 0;
            height: 3px;
            background: var(--secondary);
            border-radius: 3px 3px 0 0;
            transition: all 0.3s ease;
        }

        .tab:hover:not(.active) {
            background: rgba(52, 152, 219, 0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            padding: 25px;
            margin-bottom: 25px;
            backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card-title {
            font-size: 1.4rem;
            color: var(--secondary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            font-size: 1.2em;
        }
        
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn i {
            font-size: 1rem;
        }
        
        .btn-primary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-info {
            background: #2980b9;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 0.85rem;
            margin: 2px;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            overflow: hidden;
        }

        th {
            background: rgba(52, 152, 219, 0.15);
            color: var(--secondary);
            font-weight: 600;
            padding: 14px 18px;
            text-align: left;
            position: sticky;
            top: 0;
            backdrop-filter: blur(10px);
        }

        td {
            padding: 12px 18px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            vertical-align: middle;
        }

        tr {
            transition: background 0.2s ease;
        }

        tr:hover {
            background: rgba(52, 152, 219, 0.08);
        }

        /* Zebra striping */
        tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        tr:nth-child(even):hover {
            background: rgba(52, 152, 219, 0.08);
        }
        
        /* Status */
        .status {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            gap: 6px;
        }

        .status i {
            font-size: 0.8em;
        }

        .status-pendente {
            background: rgba(243, 156, 18, 0.15);
            color: var(--warning);
        }
        
        .status-solicitada { /* Novo status */
            background: rgba(155, 89, 182, 0.15);
            color: var(--admin);
        }

        .status-designada {
            background: rgba(52, 152, 219, 0.15);
            color: var(--secondary);
        }

        .status-concluida {
            background: rgba(39, 174, 96, 0.15);
            color: var(--success);
        }

        .status-em-andamento {
            background: rgba(155, 89, 182, 0.15);
            color: var(--admin);
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: bold;
            background: var(--secondary);
            color: white;
            margin-left: 5px;
        }
        
        /* Form Groups */
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--light);
            font-size: 0.95rem;
        }

        /* Estilização dos selects */
        select {
            background-color: rgba(30, 40, 50, 0.8);
            color: #ecf0f1;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ecf0f1'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 12px;
            width: 100%;
        }

        /* Estilo quando o select está focado */
        select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            background-color: rgba(30, 40, 50, 0.9);
        }

        /* Estilo para options */
        select option {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
        }

        /* Estilo para o hover nos options */
        select option:hover {
            background-color: var(--secondary);
        }

        /* Estilo para quando estiver em modo de preenchimento */
        .form-group.filled select {
            border-left: 3px solid var(--success);
        }

        /* Select específico para filtros */
        #filter-status, #filter-technician {
            background-color: var(--dark);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Select do laboratório */
        #activity-lab, #occurrence-lab {
            background-color: rgba(23, 32, 42, 0.9);
        }

        /* Firefox */
        @-moz-document url-prefix() {
            select {
                padding: 10px 15px;
            }
        }

        /* Internet Explorer */
        @media all and (-ms-high-contrast: none), (-ms-high-contrast: active) {
            select {
                background-image: none;
                padding-right: 15px;
            }
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            font-size: 1rem;
            color: white;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            background: rgba(255, 255, 255, 0.12);
        }

        .form-group.filled label {
            transform: translateY(-10px);
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255,255,255,0.6);
        }

        .input-with-icon input {
            padding-left: 40px;
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        /* Modals */
        .modal {
            display: none; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: rgba(23, 32, 42, 0.98);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            animation: modalFadeIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: rgba(23, 32, 42, 0.9);
            z-index: 10;
            backdrop-filter: blur(5px);
        }
        
        .modal-title {
            font-size: 1.4rem;
            color: var(--secondary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 18px 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            position: sticky;
            bottom: 0;
            background: rgba(23, 32, 42, 0.9);
            backdrop-filter: blur(5px);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #aaa;
            transition: all 0.3s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-btn:hover {
            color: white;
            background: rgba(255,255,255,0.1);
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 28px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease, fadeOut 0.5s ease 4s forwards;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .notification-success {
            background: var(--success);
            border-left: 5px solid rgba(255, 255, 255, 0.5);
        }
        
        .notification-error {
            background: var(--danger);
            border-left: 5px solid rgba(255, 255, 255, 0.5);
        }
        
        .notification-info {
            background: var(--secondary);
            border-left: 5px solid rgba(255, 255, 255, 0.5);
        }
        
        .notification-warning {
            background: var(--warning);
            border-left: 5px solid rgba(255,255,255,0.5);
        }
        
        /* Login Screen */
        .login-container {
            display: flex; 
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a2a3a, #2c3e50);
            padding: 20px;
        }
        
        .login-box {
            background: rgba(30, 40, 50, 0.9);
            border-radius: 12px;
            width: 100%;
            max-width: 450px;
            padding: 40px 35px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .login-icon {
            font-size: 4rem;
            color: var(--secondary);
            margin-bottom: 20px;
        }
        
        .login-title {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--light);
        }
        
        .login-subtitle {
            font-size: 1rem;
            color: #aaa;
            margin-bottom: 30px;
        }
                
        .password-input {
            margin-bottom: 25px;
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            font-size: 1.1rem;
            background: var(--secondary);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .login-btn:hover {
            background: #2980b9;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        /* Tech Actions */
        .tech-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .observation-item {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            margin: 10px 0;
            border-left: 3px solid var(--secondary);
        }
        
        .observation-author {
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 5px;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #aaa;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--secondary);
        }
        
        /* Data Management */
        .data-management {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .data-actions {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* Sync Button */
        .sync-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            background: var(--warning);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sync-button:hover {
            background: #e67e22;
            transform: scale(1.1);
        }
        
        .sync-button .fa-spin {
            display: none;
        }
        
        .sync-button.syncing .fa-sync {
            display: none;
        }
        
        .sync-button.syncing .fa-spin {
            display: block;
        }

        /* Loaders */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: var(--secondary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
            color: transparent;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
            
            .card-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .data-actions {
                flex-direction: column;
            }
            
            .sync-button {
                bottom: 70px;
                right: 15px;
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
        }

        /* Estilos adicionados para campos obrigatórios */
        select[required]:invalid, 
        input[required]:invalid {
            border-left: 3px solid var(--warning);
        }

        select:focus, 
        select:valid {
            border-left: 3px solid var(--success) !important;
        }

        /* Estilos para ocorrências */
        .occurrence-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--warning);
            transition: all 0.3s;
            cursor: pointer;
        }

        .occurrence-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .occurrence-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            align-items: center;
        }

        .occurrence-title {
            font-weight: 600;
            color: var(--light);
            font-size: 1.1rem;
        }

        .occurrence-date {
            color: #aaa;
            font-size: 0.85rem;
        }

        .occurrence-lab {
            display: inline-block;
            padding: 3px 8px;
            background: rgba(52, 152, 219, 0.2);
            border-radius: 4px;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .occurrence-content {
            margin-bottom: 10px;
        }

        .occurrence-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .occurrence-author {
            font-size: 0.85rem;
            color: #aaa;
        }

        .occurrence-solution {
            margin-top: 15px;
            padding: 10px;
            background: rgba(39, 174, 96, 0.1);
            border-radius: 6px;
            border-left: 3px solid var(--success);
        }

        .solution-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .solution-title {
            font-weight: 600;
            color: var(--success);
        }

        /* Estilos para os botões de exportação */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }
        .export-btn {
            padding: 8px 12px;
            font-size: 0.85rem;
        }

        /* Novos estilos para upload de imagem */
        .image-upload-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        .upload-area:hover {
            border-color: var(--secondary);
            background: rgba(52, 152, 219, 0.1);
        }
        .upload-icon {
            font-size: 2.5rem;
            color: var(--secondary);
            margin-bottom: 10px;
        }
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 15px;
            border-radius: 8px;
            display: none;
        }
        .upload-btn {
            margin-top: 10px;
        }

        .comprovante-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: var(--secondary);
            text-decoration: none;
        }
        .comprovante-link:hover {
            text-decoration: underline;
        }

        /* Estilo adicional para o modal de confirmação */
        #acknowledgment-modal .modal-content {
            max-width: 600px;
            background: rgba(33, 47, 60, 0.98);
        }
        #acknowledgment-modal .modal-body p {
            margin-bottom: 15px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="login-container" id="login-screen">
        <div class="login-box">
            <div class="login-icon">
                <i class="fas fa-flask"></i>
            </div>
            <h1 class="login-title">Sistema de Laboratórios</h1>
            <p class="login-subtitle">Acesse com suas credenciais</p>
            
            <div class="form-group">
                <label for="email">E-mail:</label>
                <input type="email" id="email" placeholder="seu@email.com">
            </div>
            <div class="form-group password-input">
                <label for="password">Senha:</label>
                <input type="password" id="password" placeholder="Digite sua senha">
            </div>
            <button class="login-btn" id="login-btn">Acessar Sistema</button>
        </div>
    </div>

    <div id="main-system" style="display: none;">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <div class="logo-icon">
                            <i class="fas fa-flask"></i>
                        </div>
                        <div class="logo-text">
                            <h1>LabQuímica</h1>
                            <p>Sistema de Gestão de Laboratórios</p>
                        </div>
                    </div>
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-details">
                            <strong id="user-name">Usuário</strong>
                            <div class="user-meta">
                                <span id="user-role" class="role-tag">Visitante</span>
                                <span id="user-status" class="connection-status online"></span>
                            </div>
                        </div>
                        <button class="btn btn-logout" id="logout-btn" title="Sair do sistema">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="tabs-container">
                <div class="tabs" id="system-tabs">
                    <div class="tab active" data-tab="atividades">
                        <i class="fas fa-tasks"></i> <span>Atividades</span>
                    </div>
                    <div class="tab" data-tab="designar">
                        <i class="fas fa-user-tag"></i> <span>Designar</span>
                    </div>
                    <div class="tab" data-tab="tecnicos">
                        <i class="fas fa-users-cog"></i> <span>Técnicos</span>
                    </div>
                    <div class="tab" data-tab="ocorrencias">
                        <i class="fas fa-exclamation-triangle"></i> <span>Ocorrências</span>
                    </div>
                    <div class="tab" data-tab="relatorios">
                        <i class="fas fa-chart-bar"></i> <span>Relatórios</span>
                    </div>
                </div>
                <div class="tab-indicator"></div>
            </div>

            <div class="tab-content active" id="atividades-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-tasks"></i> Atividades Recentes</h2>
                        <button class="btn btn-primary" id="add-activity"><i class="fas fa-plus"></i> Nova Atividade</button>
                    </div>
                    <div id="activities-container">
                        <div id="activities-empty-state" class="empty-state" style="display: none;">
                            <i class="fas fa-clipboard-list"></i>
                            <p>Nenhuma atividade encontrada.</p>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Prática</th>
                                    <th>Professor</th>
                                    <th>Laboratório</th>
                                    <th>Técnico</th>
                                    <th>Status</th>
                                    <th>Data</th>
                                    <th>Comprovante</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="activities-table">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="designar-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-user-tag"></i> Designar Técnico</h2>
                    </div>
                    <div class="form-group">
                        <label for="practice">Selecionar Prática:</label>
                        <select id="practice">
                            <option value="">-- Selecione uma prática --</option>
                            </select>
                    </div>
                    <div class="form-group">
                        <label for="technician">Designar Técnico:</label>
                        <select id="technician">
                            <option value="">-- Selecione um técnico --</option>
                            <option value="sergio@lab.com">Sérgio</option>
                            <option value="lucileide@lab.com">Lucileide</option>
                            <option value="jobim@lab.com">Jobim</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="instructions">Instruções:</label>
                        <textarea id="instructions" placeholder="Forneça instruções específicas para esta atividade..."></textarea>
                    </div>
                    <button class="btn btn-primary" id="assign-btn"><i class="fas fa-user-check"></i> Designar Atividade</button>
                </div>
            </div>

            <div class="tab-content" id="tecnicos-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-users-cog"></i> Técnicos de Laboratório</h2>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Atividades Atribuídas</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Sérgio</td>
                                <td id="tech-sergio-count">0</td>
                                <td><span class="status status-concluida"><i class="fas fa-check-circle"></i> Disponível</span></td>
                            </tr>
                            <tr>
                                <td>Lucileide</td>
                                <td id="tech-lucileide-count">0</td>
                                <td><span class="status status-concluida"><i class="fas fa-check-circle"></i> Disponível</span></td>
                            </tr>
                            <tr>
                                <td>Jobim</td>
                                <td id="tech-jobim-count">0</td>
                                <td><span class="status status-concluida"><i class="fas fa-check-circle"></i> Disponível</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-content" id="ocorrencias-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-exclamation-triangle"></i> Ocorrências nos Laboratórios</h2>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <button class="btn btn-warning" id="add-occurrence"><i class="fas fa-plus"></i> Nova Ocorrência</button>
                            <select id="filter-status" class="btn btn-sm" style="background: var(--dark); color: white;">
                                <option value="all">Todas</option>
                                <option value="pendente">Pendentes</option>
                                <option value="em-andamento">Em Andamento</option>
                                <option value="resolvido">Resolvidas</option>
                            </select>
                            <div class="export-buttons">
                                <button class="btn btn-success export-btn" id="export-pdf"><i class="fas fa-file-pdf"></i> PDF</button>
                                <button class="btn btn-success export-btn" id="export-excel"><i class="fas fa-file-excel"></i> Excel</button>
                            </div>
                        </div>
                    </div>
                    <div id="occurrences-container">
                        <div id="occurrences-empty-state" class="empty-state" style="display: none;">
                            <i class="fas fa-clipboard-list"></i>
                            <p>Nenhuma ocorrência registrada.</p>
                        </div>
                        <div id="occurrences-list">
                            </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="relatorios-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-chart-bar"></i> Relatórios e Observações</h2>
                    </div>
                    <div class="form-group">
                        <label>Filtrar por período:</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <input type="date" id="start-date" style="flex-grow: 1;">
                            <input type="date" id="end-date" style="flex-grow: 1;">
                            <button class="btn btn-primary" id="filter-reports" style="flex-shrink: 0;">Aplicar Filtro</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Filtrar por técnico:</label>
                        <select id="filter-technician">
                            <option value="all">Todos os técnicos</option>
                            <option value="sergio@lab.com">Sérgio</option>
                            <option value="lucileide@lab.com">Lucileide</option>
                            <option value="jobim@lab.com">Jobim</option>
                        </select>
                    </div>
                    <div id="reports-container">
                        <div id="reports-empty-state" class="empty-state" style="display: none;">
                            <i class="fas fa-file-alt"></i>
                            <p>Nenhum relatório encontrado para os filtros selecionados.</p>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Data da Observação</th>
                                    <th>Prática (ID)</th>
                                    <th>Técnico (Observador)</th>
                                    <th>Observações</th>
                                </tr>
                            </thead>
                            <tbody id="reports-table">
                                </tbody>
                        </table>
                    </div>
                    <div class="data-management">
                        <h3 style="margin-bottom: 15px; color: var(--light);"><i class="fas fa-database"></i> Gerenciamento de Dados</h3>
                        <div class="data-actions">
                            <button class="btn btn-danger" id="clear-all-data"><i class="fas fa-trash-alt"></i> Limpar Todos os Dados (RESET)</button>
                            <button class="btn btn-warning" id="export-all-json"><i class="fas fa-file-export"></i> Exportar Tudo (JSON)</button>
                            <input type="file" id="import-json-file" accept=".json" style="display: none;">
                            <button class="btn btn-success" id="import-all-json"><i class="fas fa-file-import"></i> Importar Dados (JSON)</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="activity-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-plus-circle"></i> Nova Atividade</h2>
                    <span class="close-btn">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="activity-form">
                        <div class="form-group">
                            <label for="activity-title">Título da Prática:</label>
                            <input type="text" id="activity-title" required placeholder="Ex: Síntese de Aspirina">
                        </div>
                        <div class="form-group">
                            <label for="activity-professor">Nome do Professor:</label>
                            <input type="text" id="activity-professor" required placeholder="Nome Completo do Professor">
                        </div>
                        <div class="form-group">
                            <label for="activity-lab">Laboratório:</label>
                            <select id="activity-lab" required>
                                <option value="">-- Selecione o Laboratório --</option>
                                <option value="Laboratório 1">Laboratório 1</option>
                                <option value="Laboratório 2">Laboratório 2</option>
                                <option value="Laboratório 3">Laboratório 3</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="activity-date">Data da Atividade:</label>
                            <input type="date" id="activity-date" required>
                        </div>
                        <div class="form-group">
                            <label for="activity-description">Descrição da Atividade:</label>
                            <textarea id="activity-description" placeholder="Detalhes sobre a prática..."></textarea>
                        </div>
                        <div class="image-upload-container">
                            <label for="activity-image-upload">Comprovante (Opcional):</label>
                            <div class="upload-area" id="activity-upload-area">
                                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                <p>Arraste e solte ou clique para selecionar uma imagem</p>
                                <input type="file" id="activity-image-upload" accept="image/*" style="display: none;">
                            </div>
                            <img id="activity-image-preview" src="#" alt="Pré-visualização da Imagem" class="image-preview">
                            <button type="button" class="btn btn-danger upload-btn" id="remove-activity-image" style="display: none;"><i class="fas fa-trash"></i> Remover Imagem</button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary close-modal-btn">Cancelar</button>
                    <button class="btn btn-primary" id="save-activity-btn">Salvar Atividade</button>
                </div>
            </div>
        </div>

        <div id="view-activity-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-info-circle"></i> Detalhes da Atividade</h2>
                    <span class="close-btn">&times;</span>
                </div>
                <div class="modal-body">
                    <p><strong>Prática:</strong> <span id="view-activity-title"></span></p>
                    <p><strong>Professor:</strong> <span id="view-activity-professor"></span></p>
                    <p><strong>Laboratório:</strong> <span id="view-activity-lab"></span></p>
                    <p><strong>Data:</strong> <span id="view-activity-date"></span></p>
                    <p><strong>Status:</strong> <span id="view-activity-status"></span></p>
                    <p><strong>Técnico Designado:</strong> <span id="view-activity-technician">N/A</span></p>
                    <p><strong>Instruções do Técnico:</strong> <span id="view-activity-instructions">N/A</span></p>
                    <p><strong>Descrição:</strong> <span id="view-activity-description"></span></p>
                    <p><strong>Registrado por:</strong> <span id="view-activity-author"></span></p>
                    <p><strong>Data de Registro:</strong> <span id="view-activity-createdAt"></span></p>
                    <p><strong>Prazo para Técnico:</strong> <span id="view-activity-dueDate"></span></p>
                    <div id="view-activity-image-container" style="margin-top: 15px; display: none;">
                        <strong>Comprovante:</strong><br>
                        <a id="view-activity-image-link" href="#" target="_blank" class="comprovante-link"><i class="fas fa-external-link-alt"></i> Visualizar Comprovante</a>
                    </div>
                    <div class="tech-actions" id="tech-actions-section" style="display: none;">
                        <h3>Ações do Técnico:</h3>
                        <div class="form-group">
                            <label for="tech-observation">Observações/Resolução:</label>
                            <textarea id="tech-observation" placeholder="Adicione observações ou descreva a resolução..."></textarea>
                        </div>
                        <button class="btn btn-success" id="complete-activity-btn"><i class="fas fa-check-circle"></i> Concluir Atividade</button>
                        <button class="btn btn-warning" id="add-observation-btn"><i class="fas fa-comment-dots"></i> Adicionar Observação</button>
                    </div>
                    <div id="observations-list" style="margin-top: 20px;">
                        <h4>Histórico de Observações:</h4>
                        <div id="no-observations" class="empty-state" style="display: none; padding: 10px;">
                            <p>Nenhuma observação ainda.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary close-modal-btn">Fechar</button>
                    <button class="btn btn-danger" id="delete-activity-btn" style="display: none;"><i class="fas fa-trash-alt"></i> Excluir</button>
                </div>
            </div>
        </div>

        <div id="occurrence-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-exclamation-circle"></i> Registrar Ocorrência</h2>
                    <span class="close-btn">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="occurrence-form">
                        <div class="form-group">
                            <label for="occurrence-title">Título da Ocorrência:</label>
                            <input type="text" id="occurrence-title" required placeholder="Ex: Lâmpada do laboratório 1 queimada">
                        </div>
                        <div class="form-group">
                            <label for="occurrence-lab">Laboratório:</label>
                            <select id="occurrence-lab" required>
                                <option value="">-- Selecione o Laboratório --</option>
                                <option value="Laboratório 1">Laboratório 1</option>
                                <option value="Laboratório 2">Laboratório 2</option>
                                <option value="Laboratório 3">Laboratório 3</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="occurrence-description">Descrição Detalhada:</label>
                            <textarea id="occurrence-description" required placeholder="Descreva o problema com detalhes..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary close-modal-btn">Cancelar</button>
                    <button class="btn btn-warning" id="save-occurrence-btn">Registrar Ocorrência</button>
                </div>
            </div>
        </div>

        <div id="view-occurrence-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-info-circle"></i> Detalhes da Ocorrência</h2>
                    <span class="close-btn">&times;</span>
                </div>
                <div class="modal-body">
                    <p><strong>Título:</strong> <span id="view-occurrence-title"></span></p>
                    <p><strong>Laboratório:</strong> <span id="view-occurrence-lab"></span></p>
                    <p><strong>Status:</strong> <span id="view-occurrence-status"></span></p>
                    <p><strong>Descrição:</strong> <span id="view-occurrence-description"></span></p>
                    <p><strong>Registrado por:</strong> <span id="view-occurrence-author"></span></p>
                    <p><strong>Data de Registro:</strong> <span id="view-occurrence-createdAt"></span></p>
                    <div id="occurrence-solution-section" style="display: none; margin-top: 15px;">
                        <p><strong>Solução:</strong> <span id="view-occurrence-solution-description"></span></p>
                        <p><strong>Resolvido por:</strong> <span id="view-occurrence-solution-author"></span></p>
                        <p><strong>Data da Solução:</strong> <span id="view-occurrence-solution-date"></span></p>
                    </div>

                    <div class="tech-actions" id="occurrence-tech-actions-section" style="display: none;">
                        <h3>Ações do Técnico:</h3>
                        <div class="form-group">
                            <label for="occurrence-solution-text">Solução:</label>
                            <textarea id="occurrence-solution-text" placeholder="Descreva a solução para esta ocorrência..."></textarea>
                        </div>
                        <button class="btn btn-success" id="resolve-occurrence-btn"><i class="fas fa-check-circle"></i> Marcar como Resolvida</button>
                        <button class="btn btn-info" id="set-occurrence-inprogress-btn"><i class="fas fa-hourglass-half"></i> Em Andamento</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary close-modal-btn">Fechar</button>
                    <button class="btn btn-danger" id="delete-occurrence-btn" style="display: none;"><i class="fas fa-trash-alt"></i> Excluir</button>
                </div>
            </div>
        </div>

        <div id="acknowledgment-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirmação de Ação</h2>
                    <span class="close-btn">&times;</span>
                </div>
                <div class="modal-body">
                    <p id="acknowledgment-message">Você tem certeza que deseja realizar esta ação?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-acknowledgment">Cancelar</button>
                    <button class="btn btn-danger" id="confirm-acknowledgment">Confirmar</button>
                </div>
            </div>
        </div>

        <button class="sync-button" id="sync-button" title="Sincronizar Dados">
            <i class="fas fa-sync"></i>
            <i class="fas fa-spinner fa-spin" style="display: none;"></i>
        </button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAIIe-xVu9ioC7dbK21oWAA37dmMEc0WRE",
            authDomain: "sistema-laboratorioifs.firebaseapp.com",
            projectId: "sistema-laboratorioifs",
            storageBucket: "sistema-laboratorioifs.firebasestorage.app",
            messagingSenderId: "950276302393",
            appId: "1:950276302393:web:745d51037ff780b1db0fe8",
            measurementId: "G-1H8P4Z6QS6"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const mainSystem = document.getElementById('main-system');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailInput = document.getElementById('email');
        const userPasswordInput = document.getElementById('password');
        const userNameSpan = document.getElementById('user-name');
        const userRoleSpan = document.getElementById('user-role');
        const userStatusSpan = document.getElementById('user-status');
        const userAvatar = document.getElementById('user-avatar');
        const systemTabs = document.getElementById('system-tabs');
        const tabIndicator = document.querySelector('.tab-indicator');

        // Modals
        const activityModal = document.getElementById('activity-modal');
        const addActivityBtn = document.getElementById('add-activity');
        const saveActivityBtn = document.getElementById('save-activity-btn');
        const activityForm = document.getElementById('activity-form');
        const activityTitleInput = document.getElementById('activity-title');
        const activityProfessorInput = document.getElementById('activity-professor');
        const activityLabSelect = document.getElementById('activity-lab');
        const activityDateInput = document.getElementById('activity-date');
        const activityDescriptionInput = document.getElementById('activity-description');
        const activityImageUpload = document.getElementById('activity-image-upload');
        const activityImagePreview = document.getElementById('activity-image-preview');
        const activityUploadArea = document.getElementById('activity-upload-area');
        const removeActivityImageBtn = document.getElementById('remove-activity-image');

        const viewActivityModal = document.getElementById('view-activity-modal');
        const viewActivityTitle = document.getElementById('view-activity-title');
        const viewActivityProfessor = document.getElementById('view-activity-professor');
        const viewActivityLab = document.getElementById('view-activity-lab');
        const viewActivityDate = document.getElementById('view-activity-date');
        const viewActivityStatus = document.getElementById('view-activity-status');
        const viewActivityTechnician = document.getElementById('view-activity-technician');
        const viewActivityInstructions = document.getElementById('view-activity-instructions');
        const viewActivityDescription = document.getElementById('view-activity-description');
        const viewActivityAuthor = document.getElementById('view-activity-author');
        const viewActivityCreatedAt = document.getElementById('view-activity-createdAt');
        const viewActivityDueDate = document.getElementById('view-activity-dueDate');
        const viewActivityImageContainer = document.getElementById('view-activity-image-container');
        const viewActivityImageLink = document.getElementById('view-activity-image-link');
        const deleteActivityBtn = document.getElementById('delete-activity-btn');

        const techActionsSection = document.getElementById('tech-actions-section');
        const techObservationInput = document.getElementById('tech-observation');
        const completeActivityBtn = document.getElementById('complete-activity-btn');
        const addObservationBtn = document.getElementById('add-observation-btn');
        const observationsList = document.getElementById('observations-list');
        const noObservationsMessage = document.getElementById('no-observations');

        const activitiesTable = document.getElementById('activities-table');
        const activitiesEmptyState = document.getElementById('activities-empty-state');

        const practiceSelect = document.getElementById('practice');
        const technicianSelect = document.getElementById('technician');
        const instructionsTextarea = document.getElementById('instructions');
        const assignBtn = document.getElementById('assign-btn');

        const techSergioCount = document.getElementById('tech-sergio-count');
        const techLucileideCount = document.getElementById('tech-lucileide-count');
        const techJobimCount = document.getElementById('tech-jobim-count');

        const addOccurrenceBtn = document.getElementById('add-occurrence');
        const occurrenceModal = document.getElementById('occurrence-modal');
        const saveOccurrenceBtn = document.getElementById('save-occurrence-btn');
        const occurrenceForm = document.getElementById('occurrence-form');
        const occurrenceTitleInput = document.getElementById('occurrence-title');
        const occurrenceLabSelect = document.getElementById('occurrence-lab');
        const occurrenceDescriptionInput = document.getElementById('occurrence-description');
        const occurrencesList = document.getElementById('occurrences-list');
        const occurrencesEmptyState = document.getElementById('occurrences-empty-state');
        const filterStatusSelect = document.getElementById('filter-status');
        const exportPdfBtn = document.getElementById('export-pdf');
        const exportExcelBtn = document.getElementById('export-excel');

        const viewOccurrenceModal = document.getElementById('view-occurrence-modal');
        const viewOccurrenceTitle = document.getElementById('view-occurrence-title');
        const viewOccurrenceLab = document.getElementById('view-occurrence-lab');
        const viewOccurrenceStatus = document.getElementById('view-occurrence-status');
        const viewOccurrenceDescription = document.getElementById('view-occurrence-description');
        const viewOccurrenceAuthor = document.getElementById('view-occurrence-author');
        const viewOccurrenceCreatedAt = document.getElementById('view-occurrence-createdAt');
        const occurrenceSolutionSection = document.getElementById('occurrence-solution-section');
        const viewOccurrenceSolutionDescription = document.getElementById('view-occurrence-solution-description');
        const viewOccurrenceSolutionAuthor = document.getElementById('view-occurrence-solution-author');
        const viewOccurrenceSolutionDate = document.getElementById('view-occurrence-solution-date');
        const occurrenceTechActionsSection = document.getElementById('occurrence-tech-actions-section');
        const occurrenceSolutionTextarea = document.getElementById('occurrence-solution-text');
        const resolveOccurrenceBtn = document.getElementById('resolve-occurrence-btn');
        const setOccurrenceInProgressBtn = document.getElementById('set-occurrence-inprogress-btn');
        const deleteOccurrenceBtn = document.getElementById('delete-occurrence-btn');

        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const filterReportsBtn = document.getElementById('filter-reports');
        const filterTechnicianSelect = document.getElementById('filter-technician');
        const reportsTable = document.getElementById('reports-table');
        const reportsEmptyState = document.getElementById('reports-empty-state');

        const clearAllDataBtn = document.getElementById('clear-all-data');
        const exportAllJsonBtn = document.getElementById('export-all-json');
        const importAllJsonBtn = document.getElementById('import-all-json');
        const importJsonFile = document.getElementById('import-json-file');

        const acknowledgmentModal = document.getElementById('acknowledgment-modal');
        const acknowledgmentMessage = document.getElementById('acknowledgment-message');
        const cancelAcknowledgmentBtn = document.getElementById('cancel-acknowledgment');
        const confirmAcknowledgmentBtn = document.getElementById('confirm-acknowledgment');

        const syncButton = document.getElementById('sync-button');

        let currentActivityId = null;
        let currentOccurrenceId = null;
        let currentUploadedFile = null;
        let currentUserRole = 'professor'; // Default role
        let currentUserEmail = null;

        // --- Utility Functions ---
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.classList.add('notification', `notification-${type}`);
            let iconClass = 'fas fa-info-circle';
            if (type === 'success') iconClass = 'fas fa-check-circle';
            if (type === 'error') iconClass = 'fas fa-exclamation-circle';
            if (type === 'warning') iconClass = 'fas fa-exclamation-triangle';
            
            notification.innerHTML = `<i class="${iconClass}"></i> ${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // --- Date and Business Hours Calculation ---
        function isBusinessDay(date) {
            const day = date.getDay();
            // Monday to Friday are business days (1 = Monday, 5 = Friday)
            return day >= 1 && day <= 5;
        }

        function calculateBusinessHours(startDate, hoursToAdd) {
            let currentDate = new Date(startDate);
            let remainingHours = hoursToAdd;

            // Set to start of current business day if it's a weekend or after hours
            if (!isBusinessDay(currentDate) || currentDate.getHours() >= 18 || currentDate.getHours() < 8) {
                currentDate.setDate(currentDate.getDate() + 1); // Move to next day
                while (!isBusinessDay(currentDate)) {
                    currentDate.setDate(currentDate.getDate() + 1); // Skip weekends
                }
                currentDate.setHours(8, 0, 0, 0); // Start at 8 AM
            }

            while (remainingHours > 0) {
                if (isBusinessDay(currentDate)) {
                    const currentHour = currentDate.getHours();
                    if (currentHour >= 8 && currentHour < 18) {
                        currentDate.setHours(currentHour + 1); // Add an hour
                        remainingHours--;
                    } else if (currentHour >= 18) {
                        currentDate.setDate(currentDate.getDate() + 1); // Move to next day
                        while (!isBusinessDay(currentDate)) {
                            currentDate.setDate(currentDate.getDate() + 1); // Skip weekends
                        }
                        currentDate.setHours(8, 0, 0, 0); // Start at 8 AM
                    } else if (currentHour < 8) {
                         currentDate.setHours(8, 0, 0, 0); // Start at 8 AM
                    }
                } else {
                    currentDate.setDate(currentDate.getDate() + 1); // Move to next day
                }
            }
            return currentDate;
        }

        function formatDateToLocaleString(date) {
            return date.toLocaleString('pt-BR', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
            }).replace(', ', ' às ');
        }

        // --- Authentication ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in.
                loginScreen.style.display = 'none';
                mainSystem.style.display = 'block';
                userNameSpan.textContent = user.email;
                userEmailInput.value = ''; // Clear email input
                userPasswordInput.value = ''; // Clear password input

                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        currentUserRole = userDoc.data().role;
                        currentUserEmail = user.email;
                        userRoleSpan.textContent = currentUserRole.charAt(0).toUpperCase() + currentUserRole.slice(1);
                        userRoleSpan.className = `role-tag role-${currentUserRole}`;
                        userAvatar.innerHTML = `<i class="fas fa-${getUserIcon(currentUserRole)}"></i>`;
                        userStatusSpan.classList.remove('offline');
                        userStatusSpan.classList.add('online');
                    } else {
                        // If user document doesn't exist, assign a default role (e.g., professor)
                        currentUserRole = 'professor';
                        currentUserEmail = user.email;
                        await db.collection('users').doc(user.uid).set({
                            email: user.email,
                            role: 'professor'
                        });
                        userRoleSpan.textContent = 'Professor';
                        userRoleSpan.className = `role-tag role-professor`;
                        userAvatar.innerHTML = `<i class="fas fa-user-tie"></i>`;
                        userStatusSpan.classList.remove('offline');
                        userStatusSpan.classList.add('online');
                        showNotification('Novo usuário registrado como Professor.', 'info');
                    }
                    displayContentForRole(currentUserRole);
                    loadActivities();
                    loadTechnicians();
                    loadOccurrences();
                    loadReports();
                } catch (error) {
                    console.error("Error fetching user role:", error);
                    showNotification('Erro ao carregar perfil do usuário: ' + error.message, 'error');
                }
            } else {
                // User is signed out.
                loginScreen.style.display = 'flex';
                mainSystem.style.display = 'none';
                userNameSpan.textContent = 'Visitante';
                userRoleSpan.textContent = 'Visitante';
                userRoleSpan.className = `role-tag`;
                userAvatar.innerHTML = `<i class="fas fa-user"></i>`;
                userStatusSpan.classList.remove('online');
                userStatusSpan.classList.add('offline');
                currentUserRole = 'professor'; // Reset role on logout
                currentUserEmail = null;
            }
        });

        function getUserIcon(role) {
            switch (role) {
                case 'admin': return 'user-shield';
                case 'tech': return 'user-cog';
                case 'professor': return 'user-tie';
                default: return 'user';
            }
        }

        loginBtn.addEventListener('click', async () => {
            const email = userEmailInput.value;
            const password = userPasswordInput.value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showNotification('Login realizado com sucesso!', 'success');
            } catch (error) {
                showNotification('Erro no login: ' + error.message, 'error');
                console.error("Login Error:", error);
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                showNotification('Logout realizado com sucesso!', 'info');
            } catch (error) {
                showNotification('Erro ao fazer logout: ' + error.message, 'error');
                console.error("Logout Error:", error);
            }
        });

        // --- Tab Navigation ---
        systemTabs.addEventListener('click', (event) => {
            const clickedTab = event.target.closest('.tab');
            if (!clickedTab) return;

            const targetTab = clickedTab.dataset.tab;

            // Restrict access based on role
            if (currentUserRole === 'professor') {
                if (targetTab === 'designar' || targetTab === 'tecnicos' || targetTab === 'relatorios') {
                    showNotification('Acesso negado. Apenas administradores e técnicos podem acessar esta aba.', 'error');
                    return;
                }
            } else if (currentUserRole === 'tech') {
                if (targetTab === 'designar' || targetTab === 'tecnicos' || targetTab === 'relatorios') {
                    // Tech can access designar, tecnicos, relatorios
                }
                if (targetTab === 'designar' && currentSelectedActivity) {
                    updateDesignationForm(currentSelectedActivity.id, currentSelectedActivity.data());
                }
            }

            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to the clicked tab and its content
            clickedTab.classList.add('active');
            document.getElementById(`${targetTab}-content`).classList.add('active');

            // Update tab indicator position and width
            const tabRect = clickedTab.getBoundingClientRect();
            const tabsContainerRect = systemTabs.getBoundingClientRect();
            tabIndicator.style.width = `${tabRect.width}px`;
            tabIndicator.style.left = `${tabRect.left - tabsContainerRect.left}px`;
        });

        // Initial tab indicator position
        document.addEventListener('DOMContentLoaded', () => {
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                const tabRect = activeTab.getBoundingClientRect();
                const tabsContainerRect = systemTabs.getBoundingClientRect();
                tabIndicator.style.width = `${tabRect.width}px`;
                tabIndicator.style.left = `${tabRect.left - tabsContainerRect.left}px`;
            }
        });

        function displayContentForRole(role) {
            // Hide all restricted elements by default
            document.getElementById('designar-content').style.display = 'none';
            document.querySelector('[data-tab="designar"]').style.display = 'none';
            document.getElementById('tecnicos-content').style.display = 'none';
            document.querySelector('[data-tab="tecnicos"]').style.display = 'none';
            document.getElementById('relatorios-content').style.display = 'none';
            document.querySelector('[data-tab="relatorios"]').style.display = 'none';
            techActionsSection.style.display = 'none';
            occurrenceTechActionsSection.style.display = 'none';
            addOccurrenceBtn.style.display = 'block'; // Default: visible for professor/admin/tech
            document.getElementById('clear-all-data').style.display = 'none'; // Admin only
            document.getElementById('delete-activity-btn').style.display = 'none'; // Admin only
            document.getElementById('delete-occurrence-btn').style.display = 'none'; // Admin only
            document.getElementById('add-activity').style.display = 'none'; // Professor/Admin only

            switch (role) {
                case 'admin':
                    document.getElementById('designar-content').style.display = 'block';
                    document.querySelector('[data-tab="designar"]').style.display = 'flex';
                    document.getElementById('tecnicos-content').style.display = 'block';
                    document.querySelector('[data-tab="tecnicos"]').style.display = 'flex';
                    document.getElementById('relatorios-content').style.display = 'block';
                    document.querySelector('[data-tab="relatorios"]').style.display = 'flex';
                    techActionsSection.style.display = 'block';
                    occurrenceTechActionsSection.style.display = 'block';
                    document.getElementById('clear-all-data').style.display = 'inline-flex';
                    document.getElementById('delete-activity-btn').style.display = 'inline-flex';
                    document.getElementById('delete-occurrence-btn').style.display = 'inline-flex';
                    document.getElementById('add-activity').style.display = 'inline-flex';
                    break;
                case 'tech':
                    document.getElementById('designar-content').style.display = 'block';
                    document.querySelector('[data-tab="designar"]').style.display = 'flex';
                    document.getElementById('tecnicos-content').style.display = 'block';
                    document.querySelector('[data-tab="tecnicos"]').style.display = 'flex';
                    document.getElementById('relatorios-content').style.display = 'block';
                    document.querySelector('[data-tab="relatorios"]').style.display = 'flex';
                    techActionsSection.style.display = 'block';
                    occurrenceTechActionsSection.style.display = 'block';
                    // Hide Add Activity for tech
                    document.getElementById('add-activity').style.display = 'none'; 
                    // Hide delete buttons for tech
                    document.getElementById('delete-activity-btn').style.display = 'none'; 
                    document.getElementById('delete-occurrence-btn').style.display = 'none'; 
                    document.getElementById('clear-all-data').style.display = 'none';
                    break;
                case 'professor':
                    // Professor can only see activities and occurrences
                    document.getElementById('activities-content').style.display = 'block';
                    document.querySelector('[data-tab="atividades"]').classList.add('active');
                    document.getElementById('ocorrencias-content').style.display = 'block';
                    document.querySelector('[data-tab="ocorrencias"]').style.display = 'flex'; // Ensure tab is visible
                    document.getElementById('add-activity').style.display = 'inline-flex';
                    // Hide designation, technicians, reports
                    document.getElementById('designar-content').style.display = 'none';
                    document.querySelector('[data-tab="designar"]').style.display = 'none';
                    document.getElementById('tecnicos-content').style.display = 'none';
                    document.querySelector('[data-tab="tecnicos"]').style.display = 'none';
                    document.getElementById('relatorios-content').style.display = 'none';
                    document.querySelector('[data-tab="relatorios"]').style.display = 'none';

                    // Ensure professor doesn't see tech actions within modals
                    techActionsSection.style.display = 'none';
                    occurrenceTechActionsSection.style.display = 'none';
                    document.getElementById('delete-activity-btn').style.display = 'none';
                    document.getElementById('delete-occurrence-btn').style.display = 'none';
                    document.getElementById('clear-all-data').style.display = 'none';
                    
                    // Set 'Atividades' as the active tab for professor
                    const atividadesTab = document.querySelector('[data-tab="atividades"]');
                    const atividadesContent = document.getElementById('atividades-content');
                    if (atividadesTab && atividadesContent) {
                        // Remove active from all others
                        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                        
                        atividadesTab.classList.add('active');
                        atividadesContent.classList.add('active');
                        // Update tab indicator
                        const tabRect = atividadesTab.getBoundingClientRect();
                        const tabsContainerRect = systemTabs.getBoundingClientRect();
                        tabIndicator.style.width = `${tabRect.width}px`;
                        tabIndicator.style.left = `${tabRect.left - tabsContainerRect.left}px`;
                    }
                    break;
            }
        }

        // --- Modals General Logic ---
        document.querySelectorAll('.close-btn, .close-modal-btn').forEach(btn => {
            btn.addEventListener('click', (event) => {
                event.target.closest('.modal').style.display = 'none';
                clearActivityForm();
                clearOccurrenceForm();
                currentUploadedFile = null; // Clear any pending file upload
            });
        });

        window.addEventListener('click', (event) => {
            if (event.target === activityModal) {
                activityModal.style.display = 'none';
                clearActivityForm();
                currentUploadedFile = null;
            }
            if (event.target === viewActivityModal) {
                viewActivityModal.style.display = 'none';
                clearActivityForm();
                currentUploadedFile = null;
            }
            if (event.target === occurrenceModal) {
                occurrenceModal.style.display = 'none';
                clearOccurrenceForm();
            }
            if (event.target === viewOccurrenceModal) {
                viewOccurrenceModal.style.display = 'none';
            }
            if (event.target === acknowledgmentModal) {
                acknowledgmentModal.style.display = 'none';
            }
        });

        // --- Activity Management ---
        addActivityBtn.addEventListener('click', () => {
            activityModal.style.display = 'flex';
            activityModal.setAttribute('data-mode', 'add');
            document.querySelector('.modal-title').innerHTML = '<i class="fas fa-plus-circle"></i> Nova Atividade';
            saveActivityBtn.textContent = 'Salvar Atividade';
            activityImagePreview.style.display = 'none';
            activityImagePreview.src = '#';
            removeActivityImageBtn.style.display = 'none';
            clearActivityForm();
        });

        activityUploadArea.addEventListener('click', () => activityImageUpload.click());
        activityImageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                currentUploadedFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    activityImagePreview.src = e.target.result;
                    activityImagePreview.style.display = 'block';
                    removeActivityImageBtn.style.display = 'inline-flex';
                };
                reader.readAsDataURL(file);
            }
        });

        removeActivityImageBtn.addEventListener('click', () => {
            currentUploadedFile = null;
            activityImageUpload.value = '';
            activityImagePreview.src = '#';
            activityImagePreview.style.display = 'none';
            removeActivityImageBtn.style.display = 'none';
        });

        saveActivityBtn.addEventListener('click', handleFormSubmit);

        async function handleFormSubmit() {
            const title = activityTitleInput.value;
            const professor = activityProfessorInput.value;
            const lab = activityLabSelect.value;
            const date = activityDateInput.value;
            const description = activityDescriptionInput.value;

            if (!title || !professor || !lab || !date) {
                showNotification('Por favor, preencha todos os campos obrigatórios para a atividade.', 'error');
                return;
            }

            const activityDate = new Date(date + 'T08:00:00'); // Assume 8 AM for activity date
            const dueDate = calculateBusinessHours(new Date(), 48); // Calculate 48 business hours from now

            let imageUrl = null;
            if (currentUploadedFile) {
                try {
                    const storageRef = storage.ref(`comprovantes/${Date.now()}_${currentUploadedFile.name}`);
                    const snapshot = await storageRef.put(currentUploadedFile);
                    imageUrl = await snapshot.ref.getDownloadURL();
                    showNotification('Comprovante enviado com sucesso!', 'success');
                } catch (error) {
                    showNotification('Erro ao enviar comprovante: ' + error.message, 'error');
                    console.error("Upload Error:", error);
                    return; // Stop if upload fails
                }
            }

            const activityData = {
                title,
                professor,
                lab,
                date: firebase.firestore.Timestamp.fromDate(activityDate),
                description,
                status: 'solicitada', // New status for professor created activities
                authorEmail: currentUserEmail,
                authorRole: currentUserRole,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                dueDate: firebase.firestore.Timestamp.fromDate(dueDate),
                imageUrl: imageUrl,
                technician: null,
                instructions: null,
                observations: []
            };

            const mode = activityModal.getAttribute('data-mode');

            try {
                if (mode === 'add') {
                    await db.collection('activities').add(activityData);
                    showNotification('Atividade registrada com sucesso!', 'success');
                } else if (mode === 'edit' && currentActivityId) {
                    await db.collection('activities').doc(currentActivityId).update(activityData);
                    showNotification('Atividade atualizada com sucesso!', 'success');
                }
                activityModal.style.display = 'none';
                clearActivityForm();
                loadActivities();
            } catch (error) {
                showNotification('Erro ao salvar atividade: ' + error.message, 'error');
                console.error("Save Activity Error:", error);
            }
        }

        function clearActivityForm() {
            activityForm.reset();
            currentActivityId = null;
            currentUploadedFile = null;
            activityImagePreview.src = '#';
            activityImagePreview.style.display = 'none';
            removeActivityImageBtn.style.display = 'none';
            // Also reset required field styling
            Array.from(activityForm.elements).forEach(element => {
                if (element.required) {
                    element.classList.remove('filled');
                }
            });
        }

        // Listener for input/select changes to apply 'filled' class for styling
        activityForm.querySelectorAll('input, select, textarea').forEach(input => {
            input.addEventListener('input', () => {
                if (input.value.trim() !== '') {
                    input.classList.add('filled');
                } else {
                    input.classList.remove('filled');
                }
            });
        });

        async function loadActivities() {
            activitiesTable.innerHTML = '';
            activitiesEmptyState.style.display = 'none';
            try {
                let query = db.collection('activities').orderBy('createdAt', 'desc');

                if (currentUserRole === 'professor') {
                    query = query.where('authorEmail', '==', currentUserEmail);
                } else if (currentUserRole === 'tech') {
                    // Tech sees activities assigned to them or unassigned ones (status 'solicitada')
                    query = query.where('status', 'in', ['solicitada', 'designada', 'em-andamento', 'concluida'])
                                .where('technician', 'in', [currentUserEmail, null]); // Include null for unassigned
                    // Refine query for tech to only show their assigned tasks or unassigned ones.
                    // This is more complex and might require two queries or client-side filtering if Firebase rules are strict.
                    // For now, assuming direct queries work, or a broader tech view.
                    // For simplicity, let's assume tech can see all if they are 'designada' or 'solicitada' if no tech is assigned.
                    // A better approach for 'tech' would be to fetch all pertinent tasks and filter client side.
                    // For now, let's keep it broad for tech to see what they might need to assign or take on.
                }

                const snapshot = await query.get();
                if (snapshot.empty) {
                    activitiesEmptyState.style.display = 'block';
                    return;
                }

                snapshot.forEach(doc => {
                    const activity = doc.data();
                    const row = activitiesTable.insertRow();
                    row.dataset.id = doc.id;

                    let statusClass = '';
                    let statusText = '';
                    let statusIcon = '';

                    switch (activity.status) {
                        case 'solicitada':
                            statusClass = 'status-solicitada';
                            statusText = 'Solicitada';
                            statusIcon = 'fas fa-hourglass-start';
                            break;
                        case 'designada':
                            statusClass = 'status-designada';
                            statusText = 'Designada';
                            statusIcon = 'fas fa-user-tag';
                            break;
                        case 'em-andamento':
                            statusClass = 'status-em-andamento';
                            statusText = 'Em Andamento';
                            statusIcon = 'fas fa-hourglass-half';
                            break;
                        case 'concluida':
                            statusClass = 'status-concluida';
                            statusText = 'Concluída';
                            statusIcon = 'fas fa-check-circle';
                            break;
                        default:
                            statusClass = 'status-pendente';
                            statusText = 'Pendente';
                            statusIcon = 'fas fa-exclamation-circle';
                    }

                    const activityDate = activity.date.toDate().toLocaleDateString('pt-BR');

                    row.innerHTML = `
                        <td>${activity.title}</td>
                        <td>${activity.professor}</td>
                        <td>${activity.lab}</td>
                        <td>${activity.technician || 'N/A'}</td>
                        <td><span class="status ${statusClass}"><i class="${statusIcon}"></i> ${statusText}</span></td>
                        <td>${activityDate}</td>
                        <td>
                            ${activity.imageUrl ? `<a href="${activity.imageUrl}" target="_blank" class="comprovante-link"><i class="fas fa-external-link-alt"></i> Ver</a>` : 'N/A'}
                        </td>
                        <td>
                            <button class="btn btn-info btn-sm view-activity-btn" data-id="${doc.id}"><i class="fas fa-eye"></i></button>
                        </td>
                    `;
                });
                attachActivityViewListeners();
                populatePracticeSelect(); // Update practices for designation
            } catch (error) {
                showNotification('Erro ao carregar atividades: ' + error.message, 'error');
                console.error("Load Activities Error:", error);
            }
        }

        function attachActivityViewListeners() {
            document.querySelectorAll('.view-activity-btn').forEach(button => {
                button.removeEventListener('click', viewActivityDetails); // Prevent multiple listeners
                button.addEventListener('click', viewActivityDetails);
            });
        }

        async function viewActivityDetails(event) {
            currentActivityId = event.currentTarget.dataset.id;
            try {
                const doc = await db.collection('activities').doc(currentActivityId).get();
                if (doc.exists) {
                    const activity = doc.data();
                    viewActivityTitle.textContent = activity.title;
                    viewActivityProfessor.textContent = activity.professor;
                    viewActivityLab.textContent = activity.lab;
                    viewActivityDate.textContent = activity.date.toDate().toLocaleDateString('pt-BR');
                    viewActivityStatus.innerHTML = `<span class="status ${getStatusClass(activity.status)}"><i class="${getStatusIcon(activity.status)}"></i> ${getStatusText(activity.status)}</span>`;
                    viewActivityTechnician.textContent = activity.technician || 'N/A';
                    viewActivityInstructions.textContent = activity.instructions || 'N/A';
                    viewActivityDescription.textContent = activity.description;
                    viewActivityAuthor.textContent = activity.authorEmail;
                    viewActivityCreatedAt.textContent = activity.createdAt ? formatDateToLocaleString(activity.createdAt.toDate()) : 'N/A';
                    viewActivityDueDate.textContent = activity.dueDate ? formatDateToLocaleString(activity.dueDate.toDate()) : 'N/A';

                    if (activity.imageUrl) {
                        viewActivityImageLink.href = activity.imageUrl;
                        viewActivityImageContainer.style.display = 'block';
                    } else {
                        viewActivityImageContainer.style.display = 'none';
                    }

                    // Show/Hide tech actions based on role and activity status
                    if (currentUserRole === 'tech' && (activity.status === 'designada' || activity.status === 'em-andamento' || activity.status === 'concluida') && activity.technician === currentUserEmail) {
                        techActionsSection.style.display = 'block';
                        completeActivityBtn.style.display = activity.status !== 'concluida' ? 'inline-flex' : 'none';
                        techObservationInput.value = ''; // Clear previous observation
                    } else if (currentUserRole === 'admin') {
                        techActionsSection.style.display = 'block';
                        completeActivityBtn.style.display = activity.status !== 'concluida' ? 'inline-flex' : 'none';
                        techObservationInput.value = '';
                    } else {
                        techActionsSection.style.display = 'none';
                    }

                    // Display delete button only for admin
                    deleteActivityBtn.style.display = currentUserRole === 'admin' ? 'inline-flex' : 'none';

                    loadActivityObservations(activity.observations || []);
                    viewActivityModal.style.display = 'flex';
                } else {
                    showNotification('Atividade não encontrada.', 'error');
                }
            } catch (error) {
                showNotification('Erro ao carregar detalhes da atividade: ' + error.message, 'error');
                console.error("View Activity Details Error:", error);
            }
        }

        function loadActivityObservations(observations) {
            observationsList.innerHTML = '<h4>Histórico de Observações:</h4>';
            if (observations.length === 0) {
                noObservationsMessage.style.display = 'block';
            } else {
                noObservationsMessage.style.display = 'none';
                observations.forEach(obs => {
                    const obsDiv = document.createElement('div');
                    obsDiv.classList.add('observation-item');
                    obsDiv.innerHTML = `
                        <div class="observation-author"><strong>${obs.authorEmail}</strong> em ${formatDateToLocaleString(obs.date.toDate())}:</div>
                        <div>${obs.description}</div>
                    `;
                    observationsList.appendChild(obsDiv);
                });
            }
        }

        addObservationBtn.addEventListener('click', async () => {
            const observationText = techObservationInput.value.trim();
            if (!observationText) {
                showNotification('Por favor, digite uma observação.', 'warning');
                return;
            }

            if (!currentActivityId) {
                showNotification('Nenhuma atividade selecionada para adicionar observação.', 'error');
                return;
            }

            try {
                await db.collection('activities').doc(currentActivityId).update({
                    observations: firebase.firestore.FieldValue.arrayUnion({
                        description: observationText,
                        authorEmail: currentUserEmail,
                        date: firebase.firestore.FieldValue.serverTimestamp()
                    })
                });
                showNotification('Observação adicionada com sucesso!', 'success');
                techObservationInput.value = '';
                // Reload activity details to show new observation
                const doc = await db.collection('activities').doc(currentActivityId).get();
                if (doc.exists) {
                    loadActivityObservations(doc.data().observations || []);
                }
            } catch (error) {
                showNotification('Erro ao adicionar observação: ' + error.message, 'error');
                console.error("Add Observation Error:", error);
            }
        });

        completeActivityBtn.addEventListener('click', async () => {
            if (!currentActivityId) {
                showNotification('Nenhuma atividade selecionada para concluir.', 'error');
                return;
            }

            acknowledgmentMessage.textContent = 'Tem certeza que deseja marcar esta atividade como CONCLUÍDA?';
            acknowledgmentModal.style.display = 'flex';

            confirmAcknowledgmentBtn.onclick = async () => {
                acknowledgmentModal.style.display = 'none';
                try {
                    await db.collection('activities').doc(currentActivityId).update({
                        status: 'concluida',
                        completedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showNotification('Atividade marcada como concluída!', 'success');
                    viewActivityModal.style.display = 'none';
                    loadActivities();
                } catch (error) {
                    showNotification('Erro ao concluir atividade: ' + error.message, 'error');
                    console.error("Complete Activity Error:", error);
                }
            };
        });

        deleteActivityBtn.addEventListener('click', async () => {
            if (!currentActivityId) {
                showNotification('Nenhuma atividade selecionada para exclusão.', 'error');
                return;
            }

            acknowledgmentMessage.textContent = 'Tem certeza que deseja EXCLUIR esta atividade? Esta ação é irreversível.';
            acknowledgmentModal.style.display = 'flex';

            confirmAcknowledgmentBtn.onclick = async () => {
                acknowledgmentModal.style.display = 'none';
                try {
                    // If there's an image, delete it from storage first
                    const doc = await db.collection('activities').doc(currentActivityId).get();
                    if (doc.exists && doc.data().imageUrl) {
                        const fileRef = storage.refFromURL(doc.data().imageUrl);
                        await fileRef.delete();
                        showNotification('Comprovante excluído do armazenamento.', 'info');
                    }
                    await db.collection('activities').doc(currentActivityId).delete();
                    showNotification('Atividade excluída com sucesso!', 'success');
                    viewActivityModal.style.display = 'none';
                    loadActivities();
                } catch (error) {
                    showNotification('Erro ao excluir atividade: ' + error.message, 'error');
                    console.error("Delete Activity Error:", error);
                }
            };
        });

        // --- Designation Management ---
        async function populatePracticeSelect() {
            practiceSelect.innerHTML = '<option value="">-- Selecione uma prática --</option>';
            try {
                // Fetch activities that are 'solicitada' and have no technician assigned
                const snapshot = await db.collection('activities')
                    .where('status', '==', 'solicitada')
                    .where('technician', '==', null)
                    .orderBy('createdAt', 'asc')
                    .get();

                if (snapshot.empty) {
                    practiceSelect.innerHTML = '<option value="">Nenhuma prática disponível para designação</option>';
                    return;
                }

                snapshot.forEach(doc => {
                    const activity = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${activity.title} (${activity.lab} - ${activity.professor})`;
                    practiceSelect.appendChild(option);
                });
            } catch (error) {
                showNotification('Erro ao carregar práticas para designação: ' + error.message, 'error');
                console.error("Populate Practice Select Error:", error);
            }
        }

        assignBtn.addEventListener('click', async () => {
            const activityId = practiceSelect.value;
            const technicianEmail = technicianSelect.value;
            const instructions = instructionsTextarea.value.trim();

            if (!activityId || !technicianEmail) {
                showNotification('Por favor, selecione uma prática e um técnico.', 'warning');
                return;
            }

            try {
                await db.collection('activities').doc(activityId).update({
                    technician: technicianEmail,
                    instructions: instructions || 'Nenhuma instrução adicional.',
                    status: 'designada'
                });
                showNotification('Atividade designada com sucesso!', 'success');
                practiceSelect.value = '';
                technicianSelect.value = '';
                instructionsTextarea.value = '';
                loadActivities(); // Reload activities to update status
                loadTechnicians(); // Update technician counts
                populatePracticeSelect(); // Refresh practice list
            } catch (error) {
                showNotification('Erro ao designar atividade: ' + error.message, 'error');
                console.error("Assign Activity Error:", error);
            }
        });

        // --- Technician Management ---
        async function loadTechnicians() {
            const technicianEmails = ['sergio@lab.com', 'lucileide@lab.com', 'jobim@lab.com'];
            const counts = { 'sergio@lab.com': 0, 'lucileide@lab.com': 0, 'jobim@lab.com': 0 };

            try {
                const snapshot = await db.collection('activities')
                    .where('status', 'in', ['designada', 'em-andamento']) // Count only active assignments
                    .get();

                snapshot.forEach(doc => {
                    const activity = doc.data();
                    if (activity.technician && counts.hasOwnProperty(activity.technician)) {
                        counts[activity.technician]++;
                    }
                });

                techSergioCount.textContent = counts['sergio@lab.com'];
                techLucileideCount.textContent = counts['lucileide@lab.com'];
                techJobimCount.textContent = counts['jobim@lab.com'];
            } catch (error) {
                showNotification('Erro ao carregar dados dos técnicos: ' + error.message, 'error');
                console.error("Load Technicians Error:", error);
            }
        }

        // --- Occurrence Management ---
        addOccurrenceBtn.addEventListener('click', () => {
            occurrenceModal.style.display = 'flex';
            occurrenceModal.setAttribute('data-mode', 'add');
            document.querySelector('#occurrence-modal .modal-title').innerHTML = '<i class="fas fa-exclamation-circle"></i> Registrar Ocorrência';
            saveOccurrenceBtn.textContent = 'Registrar Ocorrência';
            clearOccurrenceForm();
        });

        saveOccurrenceBtn.addEventListener('click', async () => {
            const title = occurrenceTitleInput.value;
            const lab = occurrenceLabSelect.value;
            const description = occurrenceDescriptionInput.value;

            if (!title || !lab || !description) {
                showNotification('Por favor, preencha todos os campos obrigatórios para a ocorrência.', 'error');
                return;
            }

            const occurrenceData = {
                title,
                lab,
                description,
                status: 'pendente',
                authorEmail: currentUserEmail,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                solution: null
            };

            const mode = occurrenceModal.getAttribute('data-mode');

            try {
                if (mode === 'add') {
                    await db.collection('occurrences').add(occurrenceData);
                    showNotification('Ocorrência registrada com sucesso!', 'success');
                } else if (mode === 'edit' && currentOccurrenceId) {
                    await db.collection('occurrences').doc(currentOccurrenceId).update(occurrenceData);
                    showNotification('Ocorrência atualizada com sucesso!', 'success');
                }
                occurrenceModal.style.display = 'none';
                clearOccurrenceForm();
                loadOccurrences();
            } catch (error) {
                showNotification('Erro ao salvar ocorrência: ' + error.message, 'error');
                console.error("Save Occurrence Error:", error);
            }
        });

        function clearOccurrenceForm() {
            occurrenceForm.reset();
            currentOccurrenceId = null;
            // Also reset required field styling
            Array.from(occurrenceForm.elements).forEach(element => {
                if (element.required) {
                    element.classList.remove('filled');
                }
            });
        }

        occurrenceForm.querySelectorAll('input, select, textarea').forEach(input => {
            input.addEventListener('input', () => {
                if (input.value.trim() !== '') {
                    input.classList.add('filled');
                } else {
                    input.classList.remove('filled');
                }
            });
        });

        async function loadOccurrences() {
            occurrencesList.innerHTML = '';
            occurrencesEmptyState.style.display = 'none';
            try {
                let query = db.collection('occurrences').orderBy('createdAt', 'desc');

                const filterStatus = filterStatusSelect.value;
                if (filterStatus !== 'all') {
                    query = query.where('status', '==', filterStatus);
                }

                const snapshot = await query.get();
                if (snapshot.empty) {
                    occurrencesEmptyState.style.display = 'block';
                    return;
                }

                snapshot.forEach(doc => {
                    const occurrence = doc.data();
                    const occDiv = document.createElement('div');
                    occDiv.classList.add('occurrence-item');
                    occDiv.dataset.id = doc.id;

                    const statusClass = getStatusClass(occurrence.status);
                    const statusText = getStatusText(occurrence.status);
                    const statusIcon = getStatusIcon(occurrence.status);

                    occDiv.innerHTML = `
                        <div class="occurrence-header">
                            <h3 class="occurrence-title">${occurrence.title}</h3>
                            <span class="occurrence-date">${occurrence.createdAt.toDate().toLocaleDateString('pt-BR')}</span>
                        </div>
                        <span class="occurrence-lab">${occurrence.lab}</span>
                        <p class="occurrence-content">${occurrence.description.substring(0, 100)}...</p>
                        <div class="occurrence-footer">
                            <span class="occurrence-author">Registrado por: ${occurrence.authorEmail}</span>
                            <span class="status ${statusClass}"><i class="${statusIcon}"></i> ${statusText}</span>
                        </div>
                    `;
                    occurrencesList.appendChild(occDiv);
                });
                attachOccurrenceViewListeners();
            } catch (error) {
                showNotification('Erro ao carregar ocorrências: ' + error.message, 'error');
                console.error("Load Occurrences Error:", error);
            }
        }

        function attachOccurrenceViewListeners() {
            document.querySelectorAll('.occurrence-item').forEach(item => {
                item.removeEventListener('click', viewOccurrenceDetails); // Prevent multiple listeners
                item.addEventListener('click', viewOccurrenceDetails);
            });
        }

        async function viewOccurrenceDetails(event) {
            currentOccurrenceId = event.currentTarget.dataset.id;
            try {
                const doc = await db.collection('occurrences').doc(currentOccurrenceId).get();
                if (doc.exists) {
                    const occurrence = doc.data();
                    viewOccurrenceTitle.textContent = occurrence.title;
                    viewOccurrenceLab.textContent = occurrence.lab;
                    viewOccurrenceStatus.innerHTML = `<span class="status ${getStatusClass(occurrence.status)}"><i class="${getStatusIcon(occurrence.status)}"></i> ${getStatusText(occurrence.status)}</span>`;
                    viewOccurrenceDescription.textContent = occurrence.description;
                    viewOccurrenceAuthor.textContent = occurrence.authorEmail;
                    viewOccurrenceCreatedAt.textContent = occurrence.createdAt ? formatDateToLocaleString(occurrence.createdAt.toDate()) : 'N/A';

                    if (occurrence.solution) {
                        occurrenceSolutionSection.style.display = 'block';
                        viewOccurrenceSolutionDescription.textContent = occurrence.solution.description;
                        viewOccurrenceSolutionAuthor.textContent = occurrence.solution.authorEmail;
                        viewOccurrenceSolutionDate.textContent = occurrence.solution.date ? formatDateToLocaleString(occurrence.solution.date.toDate()) : 'N/A';
                    } else {
                        occurrenceSolutionSection.style.display = 'none';
                    }

                    // Show/Hide tech actions based on role and occurrence status
                    if (currentUserRole === 'tech' || currentUserRole === 'admin') {
                        occurrenceTechActionsSection.style.display = 'block';
                        resolveOccurrenceBtn.style.display = occurrence.status !== 'resolvido' ? 'inline-flex' : 'none';
                        setOccurrenceInProgressBtn.style.display = (occurrence.status === 'pendente' || occurrence.status === 'designada') ? 'inline-flex' : 'none';
                        occurrenceSolutionTextarea.value = occurrence.solution ? occurrence.solution.description : '';
                    } else {
                        occurrenceTechActionsSection.style.display = 'none';
                    }

                    // Display delete button only for admin
                    deleteOccurrenceBtn.style.display = currentUserRole === 'admin' ? 'inline-flex' : 'none';

                    viewOccurrenceModal.style.display = 'flex';
                } else {
                    showNotification('Ocorrência não encontrada.', 'error');
                }
            } catch (error) {
                showNotification('Erro ao carregar detalhes da ocorrência: ' + error.message, 'error');
                console.error("View Occurrence Details Error:", error);
            }
        }

        resolveOccurrenceBtn.addEventListener('click', async () => {
            const solutionText = occurrenceSolutionTextarea.value.trim();
            if (!solutionText) {
                showNotification('Por favor, descreva a solução.', 'warning');
                return;
            }

            if (!currentOccurrenceId) {
                showNotification('Nenhuma ocorrência selecionada para resolver.', 'error');
                return;
            }

            acknowledgmentMessage.textContent = 'Tem certeza que deseja marcar esta ocorrência como RESOLVIDA?';
            acknowledgmentModal.style.display = 'flex';

            confirmAcknowledgmentBtn.onclick = async () => {
                acknowledgmentModal.style.display = 'none';
                try {
                    await db.collection('occurrences').doc(currentOccurrenceId).update({
                        status: 'resolvido',
                        solution: {
                            description: solutionText,
                            authorEmail: currentUserEmail,
                            date: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    showNotification('Ocorrência marcada como resolvida!', 'success');
                    viewOccurrenceModal.style.display = 'none';
                    loadOccurrences();
                } catch (error) {
                    showNotification('Erro ao resolver ocorrência: ' + error.message, 'error');
                    console.error("Resolve Occurrence Error:", error);
                }
            };
        });

        setOccurrenceInProgressBtn.addEventListener('click', async () => {
            if (!currentOccurrenceId) {
                showNotification('Nenhuma ocorrência selecionada.', 'error');
                return;
            }
            try {
                await db.collection('occurrences').doc(currentOccurrenceId).update({
                    status: 'em-andamento',
                });
                showNotification('Ocorrência marcada como "Em Andamento"!', 'info');
                viewOccurrenceModal.style.display = 'none';
                loadOccurrences();
            } catch (error) {
                showNotification('Erro ao atualizar status da ocorrência: ' + error.message, 'error');
                console.error("Set In Progress Error:", error);
            }
        });

        deleteOccurrenceBtn.addEventListener('click', async () => {
            if (!currentOccurrenceId) {
                showNotification('Nenhuma ocorrência selecionada para exclusão.', 'error');
                return;
            }

            acknowledgmentMessage.textContent = 'Tem certeza que deseja EXCLUIR esta ocorrência? Esta ação é irreversível.';
            acknowledgmentModal.style.display = 'flex';

            confirmAcknowledgmentBtn.onclick = async () => {
                acknowledgmentModal.style.display = 'none';
                try {
                    await db.collection('occurrences').doc(currentOccurrenceId).delete();
                    showNotification('Ocorrência excluída com sucesso!', 'success');
                    viewOccurrenceModal.style.display = 'none';
                    loadOccurrences();
                } catch (error) {
                    showNotification('Erro ao excluir ocorrência: ' + error.message, 'error');
                    console.error("Delete Occurrence Error:", error);
                }
            };
        });

        filterStatusSelect.addEventListener('change', loadOccurrences);

        // --- Export Functions for Occurrences ---
        exportPdfBtn.addEventListener('click', async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(18);
            doc.text("Relatório de Ocorrências", 14, 22);

            const data = [];
            const headers = ["Título", "Laboratório", "Status", "Descrição", "Registrado por", "Data registro", "Solução", "Resolvido por", "Data solução"];

            try {
                const snapshot = await db.collection('occurrences').orderBy('createdAt', 'desc').get();
                snapshot.forEach(occDoc => {
                    const occ = occDoc.data();
                    data.push([
                        occ.title,
                        occ.lab,
                        getStatusText(occ.status),
                        occ.description,
                        occ.authorEmail,
                        occ.createdAt ? occ.createdAt.toDate().toLocaleString('pt-BR') : 'N/A',
                        occ.solution ? occ.solution.description : 'N/A',
                        occ.solution ? occ.solution.authorEmail : 'N/A',
                        occ.solution && occ.solution.date ? occ.solution.date.toDate().toLocaleString('pt-BR') : 'N/A'
                    ]);
                });

                doc.autoTable({
                    startY: 30,
                    head: [headers],
                    body: data,
                    theme: 'striped',
                    styles: {
                        font: 'helvetica',
                        fontSize: 8,
                        cellPadding: 3,
                        valign: 'middle',
                        halign: 'left'
                    },
                    headStyles: {
                        fillColor: [52, 152, 219], // Primary color
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [240, 240, 240]
                    },
                    didDrawPage: function (data) {
                        doc.text("Página " + doc.internal.getNumberOfPages(), doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
                    }
                });
                doc.save(`ocorrencias_${new Date().toISOString().slice(0,10)}.pdf`);
                showNotification('Relatório PDF gerado com sucesso!', 'success');
            } catch (error) {
                showNotification('Erro ao gerar PDF: ' + error.message, 'error');
                console.error("PDF Export Error:", error);
            }
        });

        exportExcelBtn.addEventListener('click', async () => {
            try {
                const snapshot = await db.collection('occurrences').orderBy('createdAt', 'desc').get();
                const data = snapshot.docs.map(occDoc => {
                    const occ = occDoc.data();
                    return {
                        "Título": occ.title,
                        "Laboratório": occ.lab,
                        "Status": getStatusText(occ.status),
                        "Descrição": occ.description,
                        "Registrado por": occ.authorEmail,
                        "Data registro": occ.createdAt ? occ.createdAt.toDate().toLocaleString('pt-BR') : 'N/A',
                        "Solução": occ.solution ? occ.solution.description : 'N/A',
                        "Resolvido por": occ.solution ? occ.solution.authorEmail : 'N/A',
                        "Data solução": occ.solution && occ.solution.date ? occ.solution.date.toDate().toLocaleString('pt-BR') : 'N/A'
                    };
                });

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Ocorrências");
                XLSX.writeFile(wb, `ocorrencias_${new Date().toISOString().slice(0,10)}.xlsx`);
                showNotification('Relatório Excel gerado com sucesso!', 'success');
            } catch (error) {
                showNotification('Erro ao gerar Excel: ' + error.message, 'error');
                console.error("Excel Export Error:", error);
            }
        });


        // --- Report Management ---
        async function loadReports() {
            reportsTable.innerHTML = '';
            reportsEmptyState.style.display = 'none';

            let query = db.collection('activities');

            // Apply date filters
            const startDate = startDateInput.value ? new Date(startDateInput.value + 'T00:00:00') : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value + 'T23:59:59') : null;

            if (startDate) {
                query = query.where('createdAt', '>=', firebase.firestore.Timestamp.fromDate(startDate));
            }
            if (endDate) {
                query = query.where('createdAt', '<=', firebase.firestore.Timestamp.fromDate(endDate));
            }

            // Apply technician filter
            const filterTechnician = filterTechnicianSelect.value;
            if (filterTechnician !== 'all') {
                query = query.where('technician', '==', filterTechnician);
            } else {
                 // To include activities with null technician, we might need a composite query or client-side filtering
                 // For simplicity, for 'all' we'll just query all activities.
            }
            
            // Order by date for reports
            query = query.orderBy('createdAt', 'desc');

            try {
                const snapshot = await query.get();
                if (snapshot.empty) {
                    reportsEmptyState.style.display = 'block';
                    return;
                }

                snapshot.forEach(doc => {
                    const activity = doc.data();
                    if (activity.observations && activity.observations.length > 0) {
                        activity.observations.forEach(obs => {
                            const row = reportsTable.insertRow();
                            row.innerHTML = `
                                <td>${obs.date ? formatDateToLocaleString(obs.date.toDate()) : 'N/A'}</td>
                                <td>${doc.id} (${activity.title})</td>
                                <td>${obs.authorEmail}</td>
                                <td>${obs.description}</td>
                            `;
                        });
                    }
                });
            } catch (error) {
                showNotification('Erro ao carregar relatórios: ' + error.message, 'error');
                console.error("Load Reports Error:", error);
            }
        }

        filterReportsBtn.addEventListener('click', loadReports);
        filterTechnicianSelect.addEventListener('change', loadReports);


        // --- Data Management (Admin Only) ---
        clearAllDataBtn.addEventListener('click', () => {
            acknowledgmentMessage.textContent = 'Tem certeza que deseja LIMPAR TODOS OS DADOS do sistema? Esta ação é irreversível e excluirá todas as atividades, ocorrências e usuários (exceto admins).';
            acknowledgmentModal.style.display = 'flex';

            confirmAcknowledgmentBtn.onclick = async () => {
                acknowledgmentModal.style.display = 'none';
                try {
                    await deleteAllCollections();
                    showNotification('Todos os dados foram limpos!', 'success');
                    loadActivities();
                    loadOccurrences();
                    loadTechnicians();
                    loadReports();
                } catch (error) {
                    showNotification('Erro ao limpar dados: ' + error.message, 'error');
                    console.error("Clear All Data Error:", error);
                }
            };
        });

        async function deleteAllCollections() {
            const collections = ['activities', 'occurrences', 'users']; // Add other collections if any

            for (const collectionName of collections) {
                // For 'users', only delete non-admin users
                let query = db.collection(collectionName);
                if (collectionName === 'users') {
                    query = query.where('role', '!=', 'admin');
                }

                const snapshot = await query.get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
            }

            // Also delete all files from Firebase Storage (comprovantes)
            const storageRef = storage.ref('comprovantes');
            const listResult = await storageRef.listAll();
            for (const itemRef of listResult.items) {
                await itemRef.delete();
            }
            showNotification('Arquivos do Storage também foram limpos.', 'info');
        }

        exportAllJsonBtn.addEventListener('click', async () => {
            try {
                const data = {};
                const collections = ['activities', 'occurrences', 'users']; // Collections to export

                for (const collectionName of collections) {
                    data[collectionName] = [];
                    const snapshot = await db.collection(collectionName).get();
                    snapshot.forEach(doc => {
                        const docData = doc.data();
                        // Convert Timestamps to ISO strings for JSON readability
                        for (const key in docData) {
                            if (docData[key] && typeof docData[key].toDate === 'function') {
                                docData[key] = docData[key].toDate().toISOString();
                            }
                            if (Array.isArray(docData[key])) {
                                docData[key] = docData[key].map(item => {
                                    if (item && typeof item.date === 'object' && typeof item.date.toDate === 'function') {
                                        return { ...item, date: item.date.toDate().toISOString() };
                                    }
                                    return item;
                                });
                            }
                        }
                        data[collectionName].push({ id: doc.id, ...docData });
                    });
                }

                const filename = `firebase_backup_${new Date().toISOString().slice(0,10)}.json`;
                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('Dados exportados para JSON com sucesso!', 'success');
            } catch (error) {
                showNotification('Erro ao exportar dados para JSON: ' + error.message, 'error');
                console.error("Export JSON Error:", error);
            }
        });

        importAllJsonBtn.addEventListener('click', () => {
            importJsonFile.click();
        });

        importJsonFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    acknowledgmentMessage.textContent = 'Importar dados sobrescreverá os dados existentes. Deseja continuar?';
                    acknowledgmentModal.style.display = 'flex';

                    confirmAcknowledgmentBtn.onclick = async () => {
                        acknowledgmentModal.style.display = 'none';
                        try {
                            const importedData = JSON.parse(e.target.result);
                            await importDataToFirestore(importedData);
                            showNotification('Dados importados com sucesso!', 'success');
                            loadActivities();
                            loadOccurrences();
                            loadTechnicians();
                            loadReports();
                        } catch (error) {
                            showNotification('Erro ao importar dados: ' + error.message, 'error');
                            console.error("Import JSON Error:", error);
                        }
                    };
                };
                reader.readAsText(file);
            }
        });

        async function importDataToFirestore(data) {
            const collectionsToImport = ['users', 'activities', 'occurrences']; // Order matters for dependencies

            for (const collectionName of collectionsToImport) {
                if (data[collectionName]) {
                    const batch = db.batch();
                    data[collectionName].forEach(item => {
                        const docRef = db.collection(collectionName).doc(item.id);
                        const dataToSet = { ...item };
                        delete dataToSet.id; // Remove the ID from the data itself

                        // Convert ISO strings back to Timestamps
                        for (const key in dataToSet) {
                            if (typeof dataToSet[key] === 'string' && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z$/.test(dataToSet[key])) {
                                dataToSet[key] = firebase.firestore.Timestamp.fromDate(new Date(dataToSet[key]));
                            }
                            if (Array.isArray(dataToSet[key])) {
                                dataToSet[key] = dataToSet[key].map(arrItem => {
                                    if (arrItem && typeof arrItem.date === 'string' && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z$/.test(arrItem.date)) {
                                        return { ...arrItem, date: firebase.firestore.Timestamp.fromDate(new Date(arrItem.date)) };
                                    }
                                    return arrItem;
                                });
                            }
                        }
                        batch.set(docRef, dataToSet);
                    });
                    await batch.commit();
                }
            }
        }

        // --- Global Status Helpers ---
        function getStatusClass(status) {
            switch (status) {
                case 'pendente': return 'status-pendente';
                case 'solicitada': return 'status-solicitada';
                case 'designada': return 'status-designada';
                case 'em-andamento': return 'status-em-andamento';
                case 'concluida': return 'status-concluida';
                case 'resolvido': return 'status-concluida'; // For occurrences, resolved is like completed
                default: return '';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'pendente': return 'Pendente';
                case 'solicitada': return 'Solicitada';
                case 'designada': return 'Designada';
                case 'em-andamento': return 'Em Andamento';
                case 'concluida': return 'Concluída';
                case 'resolvido': return 'Resolvida';
                default: return 'Desconhecido';
            }
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'pendente': return 'fas fa-exclamation-circle';
                case 'solicitada': return 'fas fa-hourglass-start';
                case 'designada': return 'fas fa-user-tag';
                case 'em-andamento': return 'fas fa-hourglass-half';
                case 'concluida': return 'fas fa-check-circle';
                case 'resolvido': return 'fas fa-check-circle';
                default: return 'fas fa-question-circle';
            }
        }

        // --- Sync Button (Placeholder for now) ---
        syncButton.addEventListener('click', () => {
            syncButton.classList.add('syncing');
            showNotification('Sincronizando dados...', 'info');
            // Simulate a sync operation
            setTimeout(() => {
                syncButton.classList.remove('syncing');
                showNotification('Dados sincronizados!', 'success');
                // Reload data after sync
                loadActivities();
                loadOccurrences();
                loadTechnicians();
                loadReports();
            }, 2000);
        });

        cancelAcknowledgmentBtn.addEventListener('click', () => {
            acknowledgmentModal.style.display = 'none';
        });

    </script>
</body>
</html>
